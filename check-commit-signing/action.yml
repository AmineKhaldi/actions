name: "Check unsigned commits"
description: "Checks for unsigned commits being introduced and fails if present"

inputs:
  target:
    description: ""
    required: true
    default: ${{ github.pull_request.base.sha }}
  source:
    description: ""
    required: true
    default: ${{ github.pull_request.head.sha }}

outputs:
  status:
    description: "Set to either signed or unsigned accordingly."

runs:
  using: "composite"
  steps:
    - name: Check for unsigned commits
      if: github.event_name == 'pull_request'
      shell: bash
      run: |
        echo Target:
        git show --no-patch ${{ inputs.target }}
        echo Source:
        git show --no-patch ${{ inputs.source }}
        git log --left-right --oneline --pretty='format:%H|%aN|%aI|%s|%G?' ${{ inputs.target }}...${{ inputs.source }} > "${{ env['RUNNER_TEMP'] }}/unsigned_commit_check_log"
        echo
        echo All commits in log:
        cat "${{ env['RUNNER_TEMP'] }}/unsigned_commit_check_log"
        echo
        echo Commits in log considered unsigned:
        if grep 'N$' "${{ env['RUNNER_TEMP'] }}/unsigned_commit_check_log"
        then
          echo "status=unsigned" >> $GITHUB_OUTPUT  
          false
        else
          echo "status=signed" >> $GITHUB_OUTPUT
          true
        fi
